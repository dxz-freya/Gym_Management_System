<!-- Details.cshtml in GymManagement/Views/LibraryBranch folder-->
@model List<LibraryBranch>
@{
  int counter = 1;
}

<div class="d-flex justify-content-between align-items-center mb-3">
  <a href="@Url.Action("Create", "LibraryBranch")" class="btn custom-btn">Create</a>
  <form method="get" action="@Url.Action("Details", "LibraryBranch")" class="input-group"
    style="width: 300px; position: relative;">
    <input type="text" id="searchQuery" name="searchQuery" class="form-control"
      placeholder="Search library branches by name..." value="@Context.Request.Query["searchQuery"]" />

    <span id="clearSearchBtn" onclick="clearSearch()" class="position-absolute translate-middle-y me-3" style="cursor: pointer; position: absolute; right: 22%; top: 50%; transform: translateY(-50%);
                   display: none; z-index: 10;">
      <i class="bi bi-x-circle fs-5 text-secondary"></i>
    </span>

    <button type="submit" class="btn custom-btn">Search</button>
  </form>
</div>

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Address</th>
      <th>Phone</th>
      <th>Email</th>
      <th>Opening Hours</th>
      <th>Methods</th>
    </tr>
  </thead>
  <tbody>
    @foreach (var branch in Model)
    {
      <tr>
        <td>@counter</td>
        <td>@branch.Name</td>
        <td>@branch.Address</td>
        <td>@branch.Phone</td>
        <td>@branch.Email</td>
        <td>@branch.OpeningHours</td>
        <td>
          <a href="@Url.Action("Edit", "LibraryBranch", new { id = branch.LibraryBranchId })" class="custom-link">Edit</a>
          <a href="#" class="custom-delete delete-button" data-branch-id="@branch.LibraryBranchId">Delete</a>
        </td>
      </tr>
      counter++;
    }
  </tbody>
</table>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let searchInput = document.getElementById("searchQuery");
    let clearBtn = document.getElementById("clearSearchBtn");

    if (!searchInput || !clearBtn) {
      console.error("searchQuery or clearSearchBtn is not found");
      return;
    }

    searchInput.addEventListener("input", function () {
      if (searchInput.value.trim() !== "") {
        clearBtn.style.display = "block";
      } else {
        clearBtn.style.display = "none";
      }
    });

    window.clearSearch = function () {
      searchInput.value = "";
      clearBtn.style.display = "none";
      searchInput.focus();
      window.location.href = window.location.pathname;
    };

    clearBtn.addEventListener("click", function (event) {
      event.preventDefault();
      clearSearch();
    });

    if (searchInput.value.trim() !== "") {
      clearBtn.style.display = "block";
    }

    // DELETE LibraryBranch
    document.querySelectorAll(".delete-button").forEach(button => {
      button.addEventListener("click", function () {
        let branchId = this.getAttribute("data-branch-id");

        if (!branchId) {
          alert("Error: No branch ID provided.");
          return;
        }

        if (confirm("Are you sure you want to delete this branch?")) {
          fetch(`/LibraryBranch/Delete`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ id: parseInt(branchId) })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert("Library branch deleted successfully!");
                window.location.reload();
              } else {
                alert("Error: " + data.message);
              }
            })
            .catch(error => console.error("Error:", error));
        }
      });
    });
  });
</script>
